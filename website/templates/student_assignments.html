{% extends "base.html" %}
{% block content %}

<style>
    .assignment-list {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
    }

    .assignment-card {
        width: 100%;
        background: rgba(255,255,255,0.06);
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 0 18px rgba(0,0,0,0.4);
    }

    .assignment-card h3 {
        margin-top: 0;
        color: #dce4ff;
    }

    .badge {
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 0.85rem;
        margin-bottom: 10px;
        display: inline-block;
    }

    .badge-gold {
        background: #fdd65b;
        color: #000;
    }

    .btn-blue {
        display: inline-block;
        padding: 10px 16px;
        background: #6374ff;
        color: white;
        text-decoration: none;
        border-radius: 10px;
        margin-top: 10px;
        transition: 0.2s;
    }

    .btn-blue:hover {
        background: #7f8bff;
    }
</style>

<div class="page-title">Your Assignments</div>

{% if student and student.classes and student.classes|length > 0 %}
<div class="content-box" style="margin-bottom: 20px;">
    <h3 style="color: #c4d1ff; margin-top: 0;">Your Classes</h3>
    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
        {% for class_obj in student.classes %}
        <div style="background: rgba(255,255,255,0.08); padding: 15px; border-radius: 12px; flex: 1; min-width: 250px; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <div style="color: #ffdf9b; font-weight: 600; font-size: 1.1rem;">{{ class_obj.class_name }}</div>
                <div style="color: var(--muted-2); font-size: 0.85rem; margin-top: 4px;">Grade {{ class_obj.grade_level or "N/A" }}</div>
            </div>
            <form method="POST" action="/student/leave-class/{{ class_obj.id }}" style="display: inline;" onsubmit="return confirm('Leave {{ class_obj.class_name }}? You can rejoin later with the class code.');">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" style="background: rgba(255,68,68,0.2); color: #ff6666; border: 1px solid rgba(255,68,68,0.4); padding: 8px 14px; border-radius: 8px; cursor: pointer; font-size: 0.85rem;">
                    Leave
                </button>
            </form>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<div class="content-box">

    {% if assignment_data and assignment_data|length > 0 %}
        <div class="assignment-list">

            {% for item in assignment_data %}
            {% set a = item.assignment %}
            {% set sub = item.submission %}
            <div class="assignment-card">

                <h3>{{ a.title }}</h3>

                <p><strong>Class:</strong> {{ a.class_ref.class_name if a.class_ref else "Unknown" }}</p>
                <p><strong>Subject:</strong> {{ a.subject|title }}</p>
                <p><strong>Topic:</strong> {{ a.topic }}</p>

                {% if a.due_date %}
                    <p><strong>Due:</strong> {{ a.due_date.strftime("%B %d, %Y") }}</p>
                {% endif %}

                {# Show submission status #}
                {% if not sub %}
                    <div class="badge badge-gold">Not Started</div>
                {% elif sub.status == 'in_progress' %}
                    <div class="badge" style="background: #ffa500; color: #000;">In Progress</div>
                {% elif sub.status == 'submitted' %}
                    <div class="badge" style="background: #6495ed; color: #fff;">Submitted - Awaiting Grade</div>
                {% elif sub.status == 'graded' and sub.grade_released %}
                    <div class="badge" style="background: #32cd32; color: #000;">âœ… Graded</div>
                    <p><strong>Score:</strong> {{ sub.score|round(1) }}% ({{ sub.points_earned|round(1) }}/{{ sub.points_possible|round(1) }})</p>
                    {% if sub.feedback %}
                        <p><strong>Teacher Feedback:</strong> {{ sub.feedback }}</p>
                    {% endif %}
                {% elif sub.status == 'graded' and not sub.grade_released %}
                    <div class="badge" style="background: #ffa500; color: #000;">Graded - Pending Release</div>
                {% endif %}

                {# Action button based on status #}
                {% if not sub or sub.status == 'not_started' or sub.status == 'in_progress' %}
                    <a class="btn-blue" href="/student/assignments/{{ a.id }}/start">
                        ğŸš€ {% if sub and sub.status == 'in_progress' %}Continue{% else %}Start{% endif %} Mission
                    </a>
                {% elif sub.status == 'submitted' or (sub.status == 'graded' and not sub.grade_released) %}
                    <a class="btn-blue" href="/student/assignments/{{ a.id }}/start">
                        ğŸ‘ï¸ View Submission
                    </a>
                {% elif sub.status == 'graded' and sub.grade_released %}
                    <a class="btn-blue" href="/student/assignments/{{ a.id }}/start">
                        ğŸ“Š View Graded Assignment
                    </a>
                {% endif %}
            </div>
            {% endfor %}

        </div>
    {% else %}
        <p style="text-align:center; margin-top:20px;">
            You currently have <strong>no published missions</strong> assigned.
        </p>
    {% endif %}

</div>

{% endblock %}
