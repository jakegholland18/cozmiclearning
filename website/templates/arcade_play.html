{% extends "layout.html" %}
{% block content %}

<style>
    .game-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 40px 20px;
        text-align: center;
    }

    .game-header {
        margin-bottom: 40px;
    }

    .game-title {
        font-size: 2.5rem;
        font-weight: 900;
        background: linear-gradient(135deg, #ff6fd8, #00f2ff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 10px;
    }

    .game-timer {
        font-size: 3rem;
        font-weight: 900;
        color: #00f2ff;
        margin: 20px 0;
        font-family: 'Courier New', monospace;
    }

    .game-progress {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 30px;
    }

    .progress-stat {
        background: rgba(0, 0, 0, 0.3);
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: 700;
    }

    .question-card {
        background: var(--glass-1);
        border: 2px solid var(--border-soft);
        border-radius: 16px;
        padding: 40px;
        margin-bottom: 30px;
        min-height: 200px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .question-text {
        font-size: 2.2rem;
        font-weight: 800;
        color: var(--text);
        margin-bottom: 30px;
    }

    .answer-input {
        font-size: 1.8rem;
        padding: 15px 25px;
        background: rgba(0, 0, 0, 0.3);
        border: 2px solid var(--border-soft);
        border-radius: 12px;
        color: var(--text);
        text-align: center;
        width: 300px;
        margin: 0 auto;
        font-weight: 700;
    }

    .answer-input:focus {
        outline: none;
        border-color: #00f2ff;
        box-shadow: 0 0 20px rgba(0, 242, 255, 0.3);
    }

    .options-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        max-width: 600px;
        margin: 0 auto;
    }

    .option-btn {
        padding: 20px;
        background: linear-gradient(135deg, rgba(92, 107, 255, 0.2), rgba(0, 242, 255, 0.1));
        border: 2px solid rgba(92, 107, 255, 0.4);
        border-radius: 12px;
        color: var(--text);
        font-size: 1.1rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .option-btn:hover {
        transform: translateY(-5px) scale(1.05);
        border-color: #00f2ff;
        box-shadow: 0 8px 25px rgba(0, 242, 255, 0.3);
    }

    .option-btn.correct {
        background: linear-gradient(135deg, rgba(76, 175, 80, 0.3), rgba(76, 175, 80, 0.2));
        border-color: #4caf50;
        animation: correctPulse 0.5s ease;
    }

    .option-btn.incorrect {
        background: linear-gradient(135deg, rgba(255, 107, 107, 0.3), rgba(255, 77, 77, 0.2));
        border-color: #ff6b6b;
        animation: incorrectShake 0.5s ease;
    }

    @keyframes correctPulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }

    @keyframes incorrectShake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-10px); }
        75% { transform: translateX(10px); }
    }

    .submit-btn {
        padding: 15px 40px;
        background: linear-gradient(135deg, var(--primary), var(--accent));
        border: none;
        border-radius: 12px;
        color: var(--text);
        font-size: 1.2rem;
        font-weight: 800;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 20px;
    }

    .submit-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 30px rgba(92, 107, 255, 0.4);
    }

    .results-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 10000;
    }

    .results-modal.show {
        display: flex;
    }

    .results-content {
        background: linear-gradient(135deg, rgba(10, 14, 39, 0.95), rgba(5, 8, 19, 0.98));
        border: 3px solid #00f2ff;
        border-radius: 24px;
        padding: 50px;
        max-width: 600px;
        text-align: center;
        animation: resultsAppear 0.5s ease;
    }

    @keyframes resultsAppear {
        from {
            opacity: 0;
            transform: scale(0.8) translateY(50px);
        }
        to {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
    }

    .results-title {
        font-size: 3rem;
        font-weight: 900;
        margin-bottom: 20px;
    }

    .results-stats {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin: 30px 0;
    }

    .result-stat {
        background: rgba(0, 0, 0, 0.4);
        padding: 20px;
        border-radius: 12px;
    }

    .result-stat-label {
        font-size: 0.9rem;
        color: var(--muted-2);
        margin-bottom: 8px;
    }

    .result-stat-value {
        font-size: 2.5rem;
        font-weight: 900;
        background: linear-gradient(135deg, #ffdd55, #ff6fd8);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
</style>

<div class="game-container fade-in">
    
    <div class="game-header">
        <h1 class="game-title">{{ game.icon }} {{ game.name }}</h1>
        <div class="game-timer" id="timer">60</div>
        
        <div class="game-progress">
            <div class="progress-stat">
                Question: <span id="current-question">1</span>/<span id="total-questions">{{ questions|length }}</span>
            </div>
            <div class="progress-stat">
                Score: <span id="score">0</span>
            </div>
            <div class="progress-stat">
                Correct: <span id="correct">0</span>
            </div>
        </div>
    </div>

    <div class="question-card" id="question-container">
        <!-- Questions will be loaded here by JavaScript -->
    </div>

    <button class="submit-btn" id="start-btn" onclick="startGame()">Start Game!</button>

</div>

<!-- Results Modal -->
<div class="results-modal" id="results-modal">
    <div class="results-content">
        <div class="results-title" id="results-title">üéâ Game Complete! üéâ</div>
        
        <div class="results-stats">
            <div class="result-stat">
                <div class="result-stat-label">Final Score</div>
                <div class="result-stat-value" id="final-score">0</div>
            </div>
            <div class="result-stat">
                <div class="result-stat-label">Accuracy</div>
                <div class="result-stat-value" id="final-accuracy">0%</div>
            </div>
            <div class="result-stat">
                <div class="result-stat-label">Time</div>
                <div class="result-stat-value" id="final-time">0s</div>
            </div>
            <div class="result-stat">
                <div class="result-stat-label">XP Earned</div>
                <div class="result-stat-value" id="xp-earned">+0</div>
            </div>
        </div>

        <div style="margin-top: 30px;">
            <a href="/arcade/game/{{ game.game_key }}" class="submit-btn">Play Again</a>
            <a href="/arcade" class="submit-btn" style="background: linear-gradient(135deg, #ff6fd8, #ffdd55); margin-left: 15px;">Arcade Hub</a>
        </div>
    </div>
</div>

<script>
    const questions = {{ questions | tojson }};
    const gameKey = "{{ game.game_key }}";
    let currentIndex = 0;
    let score = 0;
    let correct = 0;
    let timeLeft = 60;
    let timerInterval = null;
    let gameStartTime = null;

    function startGame() {
        document.getElementById('start-btn').style.display = 'none';
        gameStartTime = Date.now();
        showQuestion();
        startTimer();
    }

    function startTimer() {
        timerInterval = setInterval(() => {
            timeLeft--;
            document.getElementById('timer').textContent = timeLeft;
            
            if (timeLeft <= 10) {
                document.getElementById('timer').style.color = '#ff6b6b';
            }
            
            if (timeLeft <= 0) {
                endGame();
            }
        }, 1000);
    }

    function showQuestion() {
        if (currentIndex >= questions.length) {
            endGame();
            return;
        }

        const question = questions[currentIndex];
        const container = document.getElementById('question-container');
        
        document.getElementById('current-question').textContent = currentIndex + 1;

        if (question.options) {
            // Multiple choice
            container.innerHTML = `
                <div class="question-text">${question.question || question.word}</div>
                <div class="options-grid">
                    ${question.options.map((opt, i) => `
                        <button class="option-btn" onclick="checkAnswer('${opt}')">${opt}</button>
                    `).join('')}
                </div>
            `;
        } else {
            // Text input
            container.innerHTML = `
                <div class="question-text">${question.question}</div>
                <input type="text" class="answer-input" id="answer-input" placeholder="Your answer" 
                       onkeypress="if(event.key === 'Enter') checkAnswer(document.getElementById('answer-input').value)">
                <button class="submit-btn" onclick="checkAnswer(document.getElementById('answer-input').value)">Submit</button>
            `;
            setTimeout(() => document.getElementById('answer-input').focus(), 100);
        }
    }

    function checkAnswer(userAnswer) {
        const question = questions[currentIndex];
        const correctAnswer = (question.answer || question.definition).toString().toLowerCase().trim();
        const isCorrect = userAnswer.toLowerCase().trim() === correctAnswer;

        if (isCorrect) {
            correct++;
            score += 100;
            document.getElementById('correct').textContent = correct;
            document.getElementById('score').textContent = score;
            CozmicEnhancements.launchConfetti(10);
        }

        currentIndex++;
        setTimeout(showQuestion, 500);
    }

    function endGame() {
        clearInterval(timerInterval);
        const totalTime = Math.floor((Date.now() - gameStartTime) / 1000);
        const accuracy = Math.round((correct / questions.length) * 100);

        // Submit results to server
        fetch('/arcade/submit', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                game_key: gameKey,
                score: score,
                correct: correct,
                total: questions.length,
                time_seconds: totalTime
            })
        })
        .then(response => response.json())
        .then(data => {
            showResults(score, accuracy, totalTime, data.xp_earned, data.new_high_score);
        });
    }

    function showResults(finalScore, accuracy, time, xp, isHighScore) {
        document.getElementById('final-score').textContent = finalScore;
        document.getElementById('final-accuracy').textContent = accuracy + '%';
        document.getElementById('final-time').textContent = time + 's';
        document.getElementById('xp-earned').textContent = '+' + xp;

        if (isHighScore) {
            document.getElementById('results-title').textContent = 'üèÜ NEW HIGH SCORE! üèÜ';
            CozmicEnhancements.celebrationBurst();
        } else {
            CozmicEnhancements.launchConfetti(50);
        }

        document.getElementById('results-modal').classList.add('show');
    }
</script>

{% endblock %}
