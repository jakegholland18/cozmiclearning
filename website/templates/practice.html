<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Practice Mode</title>

    <link rel="stylesheet" href="/static/style.css">

    <style>
        body {
            background: radial-gradient(circle at top, #0f1a2b, #000814);
            font-family: "Poppins", sans-serif;
            color: white;
            margin: 0;
            padding: 0;
        }

        .stars {
            position: fixed;
            inset: 0;
            background: url('/static/stars.png');
            background-size: cover;
            opacity: 0.28;
            z-index: -1;
            animation: drift 55s linear infinite;
        }

        @keyframes drift { 
            from { transform: translateY(0); }
            to { transform: translateY(-1800px); }
        }

        .practice-container {
            width: 90%;
            max-width: 900px;
            margin: 40px auto 60px;
            background: rgba(255,255,255,0.06);
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 0 25px rgba(0,0,0,0.6);
            backdrop-filter: blur(6px);
        }

        /* Return button */
        .return-row {
            margin-bottom: 10px;
        }
        .return-btn {
            background: transparent;
            border: none;
            color: #9ecaff;
            font-size: 0.95rem;
            cursor: pointer;
        }
        .return-btn:hover { text-decoration: underline; }

        /* Avatar */
        .avatar {
            width: 150px;
            height: auto;
            display: block;
            margin: 0 auto 10px;
            animation: floating 3s ease-in-out infinite;
        }

        @keyframes floating {
            0% { transform: translateY(0); }
            50% { transform: translateY(-6px); }
            100% { transform: translateY(0); }
        }

        .prompt-title {
            text-align: center;
            font-size: 1.6rem;
            margin-bottom: 15px;
        }

        .prompt-box {
            background: rgba(255,255,255,0.12);
            padding: 20px;
            border-radius: 15px;
            font-size: 1.2rem;
            margin-bottom: 20px;
        }

        /* Topic selection */
        #topic-section { text-align: center; margin-bottom: 25px; }
        #topic-input {
            padding: 12px;
            width: 70%;
            max-width: 450px;
            border-radius: 10px;
            border: none;
            outline: none;
            margin-top: 8px;
        }

        #start-topic-btn {
            margin-top: 10px;
            padding: 12px 20px;
            background: #1e88ff;
            border-radius: 10px;
            border: none;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }

        /* Multiple choice */
        #choices-container {
            display: none;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }

        .choice-btn {
            padding: 10px 14px;
            border-radius: 10px;
            background: rgba(255,255,255,0.9);
            color: #111;
            cursor: pointer;
            border: none;
        }
        .choice-btn:hover { background: #daf0ff; }

        /* Free response input */
        .input-row {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }

        #student-answer {
            flex-grow: 1;
            padding: 12px;
            border-radius: 10px;
            border: none;
            outline: none;
        }

        .submit-btn {
            background: #1e88ff;
            border: none;
            padding: 12px 18px;
            border-radius: 10px;
            color: white;
            cursor: pointer;
        }

        .status-message {
            margin-top: 15px;
            text-align: center;
            min-height: 25px;
        }

        /* Session end */
        #session-actions { text-align: center; margin-top: 20px; display:none; }
        #session-actions button {
            margin: 6px; padding: 10px 18px;
            border-radius: 10px; border: none; cursor: pointer; font-weight: 600;
        }
        .session-primary { background:#1e88ff; color:white; }
        .session-secondary { background:white; color:#111; }

        /* Help chat */
        .help-container {
            margin-top: 40px;
            padding: 20px;
            background: rgba(255,255,255,0.09);
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.15);
        }

        .help-title {
            font-size: 1.3rem;
            margin-bottom: 10px;
            text-align: center;
        }

        .help-log {
            max-height: 250px;
            overflow-y: auto;
            padding: 12px;
            background: rgba(0,0,0,0.25);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .help-msg {
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 8px;
        }

        .help-user { background: rgba(255,255,255,0.3); text-align:right; }
        .help-ai { background: rgba(255,255,255,0.15); text-align:left; }

        .help-input-row {
            display: flex;
            gap: 10px;
        }

        .help-input-row textarea {
            flex-grow: 1;
            padding: 10px;
            height: 60px;
            border-radius: 8px;
            resize: none;
            border: none;
            outline: none;
        }

        .help-send-btn {
            width: 120px;
            background: #1a72ff;
            border-radius: 10px;
            border: none;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }

        #thinking-help {
            text-align:center;
            display:none;
            margin-top:8px;
            font-size:0.9rem;
            color:#9ecaff;
        }
    </style>
</head>

<body>
<div class="stars"></div>

<div class="practice-container">

    <!-- Return button -->
    <div class="return-row">
        <button class="return-btn" onclick="window.location.href='/ask-question?subject={{ subject }}&grade={{ grade }}'">
            ‚¨Ö Back to Question
        </button>
    </div>

    <img id="character-avatar" class="avatar" src="/static/characters/{{ character }}.png">

    <h2 class="prompt-title">üöÄ Practice Mission</h2>

    <!-- Topic selection -->
    <div id="topic-section">
        <div>What topic would you like to practice?</div>
        <input id="topic-input" placeholder="e.g. fractions, decimals, reading...">
        <br>
        <button id="start-topic-btn">Start Practice</button>
    </div>

    <!-- Mission -->
    <div id="practice-section" style="display:none;">

        <div id="practice-prompt" class="prompt-box">
            Loading your first challenge‚Ä¶
        </div>

        <!-- Choices -->
        <div id="choices-container"></div>

        <!-- Free response -->
        <div class="input-row" id="free-response-row">
            <input id="student-answer" placeholder="Type your answer‚Ä¶">
            <button class="submit-btn" onclick="sendPracticeAnswer()">Submit</button>
        </div>

        <div id="status" class="status-message"></div>

        <!-- Ending -->
        <div id="session-actions">
            <button class="session-primary" onclick="restartSameTopic()">üîÅ More questions on this topic</button>
            <button class="session-secondary" onclick="chooseNewTopic()">üîÑ New topic</button>
        </div>
    </div>

    <!-- HELP CHAT -->
    <div class="help-container">
        <div class="help-title">üí¨ Need help? Ask your tutor!</div>

        <div id="help-log" class="help-log"></div>

        <div id="thinking-help">ü§ñ Thinking...</div>

        <div class="help-input-row">
            <textarea id="help-msg" placeholder="Ask a question about the problem‚Ä¶"></textarea>
            <button class="help-send-btn" onclick="sendHelp()">Send</button>
        </div>
    </div>

    <!-- FOOTER -->
    <div style="text-align:center; margin-top:35px; opacity:0.7; font-size:0.9rem;">
        <a href="/terms" style="color:#9ecaff; margin:0 10px;">Terms</a> |
        <a href="/privacy" style="color:#9ecaff; margin:0 10px;">Privacy Policy</a> |
        <a href="/disclaimer" style="color:#9ecaff; margin:0 10px;">Disclaimer</a>
        <div style="margin-top:8px; font-size:0.8rem;">
            Homework Buddy is an educational tool. Always check important facts for accuracy.
        </div>
    </div>

</div>

<!-- SCRIPT -->
<script>
let currentTopic = "";
let currentType = "free";
const subject = "{{ subject }}";

// Start topic
document.getElementById("start-topic-btn").addEventListener("click", startFromTopic);

function startFromTopic() {
    const topic = document.getElementById("topic-input").value.trim();
    if (!topic) return;

    currentTopic = topic;

    document.getElementById("topic-section").style.display = "none";
    document.getElementById("practice-section").style.display = "block";

    startPractice();
}

function restartSameTopic() {
    document.getElementById("session-actions").style.display = "none";
    startPractice();
}

function chooseNewTopic() {
    document.getElementById("practice-section").style.display = "none";
    document.getElementById("topic-section").style.display = "block";
    document.getElementById("status").innerHTML = "";
    document.getElementById("session-actions").style.display = "none";
    document.getElementById("topic-input").value = "";
}

function startPractice() {
    const status = document.getElementById("status");
    status.innerHTML = "<span class='thinking'>ü§ñ Preparing mission‚Ä¶</span>";

    fetch("/start_practice", {
        method: "POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ 
            topic: currentTopic,
            subject: subject 
        })
    })
    .then(r => r.json())
    .then(data => {
        document.getElementById("practice-prompt").innerText = data.prompt;
        setQuestionType(data);
        document.getElementById("status").innerHTML = "";
    });
}

function setQuestionType(data) {
    const choicesDiv = document.getElementById("choices-container");
    const freeRow = document.getElementById("free-response-row");
    const box = document.getElementById("student-answer");

    currentType = data.type || "free";

    if (currentType === "multiple_choice" && data.choices?.length) {
        choicesDiv.innerHTML = "";
        data.choices.forEach(c => {
            const btn = document.createElement("button");
            btn.className = "choice-btn";
            btn.textContent = c;
            btn.onclick = () => sendPracticeAnswer(c);
            choicesDiv.appendChild(btn);
        });
        choicesDiv.style.display = "flex";
        freeRow.style.display = "none";
    } else {
        choicesDiv.style.display = "none";
        freeRow.style.display = "flex";
        box.value = "";
    }
}

// ENTER key input
document.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && document.getElementById("free-response-row").style.display !== "none") {
        e.preventDefault();
        sendPracticeAnswer();
    }
});

async function sendPracticeAnswer(choiceValue=null) {
    const answer = choiceValue || document.getElementById("student-answer").value.trim();
    if (!answer) return;

    const status = document.getElementById("status");

    status.innerHTML = "<span class='thinking'>ü§ñ Checking‚Ä¶</span>";

    const res = await fetch("/practice_step", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ answer })
    });

    const data = await res.json();
    const promptBox = document.getElementById("practice-prompt");
    const actions = document.getElementById("session-actions");

    if (data.status === "correct") {
        status.innerHTML = "‚úÖ Correct!";
        promptBox.innerText = data.next_prompt;
        setQuestionType(data);
    }
    else if (data.status === "incorrect") {
        status.innerHTML = "‚ùå Try again ‚Äî Hint: " + (data.hint || "");
    }
    else if (data.status === "guided") {
        status.innerHTML = "üß† Let's break it down:<br>" + data.explanation;
        promptBox.innerText = data.next_prompt;
        setQuestionType(data);
    }
    else if (data.status === "finished") {
        status.innerHTML = "üåü " + data.message;
        promptBox.innerText = "Mission Complete!";
        actions.style.display = "block";
    }
}

async function sendHelp() {
    const msgBox = document.getElementById("help-msg");
    const log = document.getElementById("help-log");
    const thinking = document.getElementById("thinking-help");

    const text = msgBox.value.trim();
    if (!text) return;

    msgBox.value = "";

    log.innerHTML += `<div class="help-msg help-user">${text}</div>`;
    log.scrollTop = log.scrollHeight;

    thinking.style.display = "block";

    const res = await fetch("/practice_help_message", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ message: text })
    });

    thinking.style.display = "none";

    const data = await res.json();
    log.innerHTML += `<div class="help-msg help-ai">${data.reply}</div>`;
    log.scrollTop = log.scrollHeight;
}
</script>

</body>
</html>


