{% extends "base.html" %}

{% block title %}Moderation Statistics{% endblock %}

{% block content %}
<style>
    .stats-dashboard {
        max-width: 1600px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }
    
    .time-selector {
        display: flex;
        gap: 10px;
    }
    
    .time-btn {
        padding: 10px 20px;
        border-radius: 8px;
        border: 2px solid #ddd;
        background: white;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .time-btn.active {
        background: #667eea;
        color: white;
        border-color: #667eea;
    }
    
    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .metric-card {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .metric-label {
        font-size: 14px;
        color: #6c757d;
        margin-bottom: 8px;
    }
    
    .metric-value {
        font-size: 36px;
        font-weight: bold;
        color: #333;
    }
    
    .metric-change {
        font-size: 13px;
        margin-top: 8px;
    }
    
    .metric-change.up {
        color: #dc3545;
    }
    
    .metric-change.down {
        color: #28a745;
    }
    
    .chart-card {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .chart-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 20px;
        color: #333;
    }
    
    .bar-chart {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    .bar-row {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .bar-label {
        width: 150px;
        font-size: 14px;
        color: #495057;
    }
    
    .bar-container {
        flex: 1;
        height: 30px;
        background: #e9ecef;
        border-radius: 6px;
        overflow: hidden;
        position: relative;
    }
    
    .bar-fill {
        height: 100%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        transition: width 0.3s ease;
        display: flex;
        align-items: center;
        padding: 0 10px;
        color: white;
        font-weight: 600;
        font-size: 13px;
    }
    
    .bar-fill.high {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .bar-fill.medium {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }
    
    .bar-fill.low {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .severity-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
    }
    
    .severity-card {
        padding: 20px;
        border-radius: 12px;
        color: white;
        text-align: center;
    }
    
    .severity-card.high {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .severity-card.medium {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }
    
    .severity-card.low {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .severity-number {
        font-size: 48px;
        font-weight: bold;
        margin: 10px 0;
    }
    
    .severity-label {
        font-size: 16px;
        opacity: 0.9;
    }
    
    .top-students-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .top-students-table th {
        background: #f8f9fa;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid #dee2e6;
    }
    
    .top-students-table td {
        padding: 12px;
        border-bottom: 1px solid #dee2e6;
    }
    
    .trend-chart {
        height: 200px;
        display: flex;
        align-items: flex-end;
        gap: 10px;
        padding: 20px 0;
    }
    
    .trend-bar {
        flex: 1;
        background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
        border-radius: 4px 4px 0 0;
        position: relative;
        min-height: 10px;
    }
    
    .trend-label {
        position: absolute;
        bottom: -25px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 11px;
        color: #6c757d;
        white-space: nowrap;
    }
</style>

<div class="stats-dashboard">
    <div class="page-header">
        <h1>üìä Moderation Statistics</h1>
        <div class="time-selector">
            <a href="?period=7" class="time-btn {% if period == '7' %}active{% endif %}">7 Days</a>
            <a href="?period=30" class="time-btn {% if period == '30' %}active{% endif %}">30 Days</a>
            <a href="?period=90" class="time-btn {% if period == '90' %}active{% endif %}">90 Days</a>
            <a href="?period=all" class="time-btn {% if period == 'all' %}active{% endif %}">All Time</a>
        </div>
    </div>
    
    <!-- Key Metrics -->
    <div class="stats-row">
        <div class="metric-card">
            <div class="metric-label">Total Questions</div>
            <div class="metric-value">{{ stats.total_questions }}</div>
            <div class="metric-change">{{ stats.question_change }}% vs last period</div>
        </div>
        
        <div class="metric-card">
            <div class="metric-label">Flagged Questions</div>
            <div class="metric-value">{{ stats.flagged_questions }}</div>
            <div class="metric-change {% if stats.flag_rate_change > 0 %}up{% else %}down{% endif %}">
                {{ stats.flag_rate }}% flag rate
            </div>
        </div>
        
        <div class="metric-card">
            <div class="metric-label">Blocked Content</div>
            <div class="metric-value">{{ stats.blocked_questions }}</div>
            <div class="metric-change {% if stats.block_rate_change > 0 %}up{% else %}down{% endif %}">
                {{ stats.block_rate }}% block rate
            </div>
        </div>
        
        <div class="metric-card">
            <div class="metric-label">Parent Notifications</div>
            <div class="metric-value">{{ stats.parent_notifications }}</div>
            <div class="metric-change">{{ stats.notification_rate }}% of flagged</div>
        </div>
    </div>
    
    <!-- Severity Breakdown -->
    <div class="chart-card">
        <div class="chart-title">Severity Distribution</div>
        <div class="severity-grid">
            <div class="severity-card high">
                <div class="severity-label">üî¥ High Risk</div>
                <div class="severity-number">{{ stats.high_severity }}</div>
                <div class="severity-label">{{ stats.high_severity_pct }}% of flagged</div>
            </div>
            
            <div class="severity-card medium">
                <div class="severity-label">üü° Medium Risk</div>
                <div class="severity-number">{{ stats.medium_severity }}</div>
                <div class="severity-label">{{ stats.medium_severity_pct }}% of flagged</div>
            </div>
            
            <div class="severity-card low">
                <div class="severity-label">üü¢ Low Risk</div>
                <div class="severity-number">{{ stats.low_severity }}</div>
                <div class="severity-label">{{ stats.low_severity_pct }}% of flagged</div>
            </div>
        </div>
    </div>
    
    <!-- Flagged Categories -->
    <div class="chart-card">
        <div class="chart-title">Top Flagged Reasons</div>
        <div class="bar-chart">
            {% for reason, count in stats.top_reasons %}
            <div class="bar-row">
                <div class="bar-label">{{ reason }}</div>
                <div class="bar-container">
                    <div class="bar-fill" style="width: {{ (count / stats.flagged_questions * 100) if stats.flagged_questions > 0 else 0 }}%">
                        {{ count }}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Daily Trend -->
    <div class="chart-card">
        <div class="chart-title">Flagged Questions Over Time</div>
        <div class="trend-chart">
            {% for day in stats.daily_trend %}
            <div class="trend-bar" style="height: {{ (day.count / stats.max_daily * 100) if stats.max_daily > 0 else 10 }}%">
                <span class="trend-label">{{ day.date }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Students Needing Attention -->
    <div class="chart-card">
        <div class="chart-title">Students with Most Flagged Content</div>
        <table class="top-students-table">
            <thead>
                <tr>
                    <th>Student</th>
                    <th>Total Flagged</th>
                    <th>High Severity</th>
                    <th>Last Incident</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for student in stats.top_students %}
                <tr>
                    <td>{{ student.name }}</td>
                    <td>{{ student.flagged_count }}</td>
                    <td>{{ student.high_count }}</td>
                    <td>{{ student.last_flagged.strftime('%m/%d/%y') if student.last_flagged else 'N/A' }}</td>
                    <td>
                        {% if student.high_count > 0 %}
                        <span style="color: #dc3545; font-weight: 600;">‚ö†Ô∏è Needs Review</span>
                        {% else %}
                        <span style="color: #6c757d;">Monitoring</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <div style="text-align: center; margin-top: 30px;">
        <a href="/admin/moderation" class="btn-sm btn-review" style="padding: 12px 24px; text-decoration: none; display: inline-block;">‚Üê Back to Moderation Dashboard</a>
    </div>
</div>

{% endblock %}
