{% extends "layout.html" %}
{% block content %}

<style>
/* PowerGrid Electric Theme */
body {
    background: linear-gradient(135deg, #0a0e1f 0%, #050813 100%);
    overflow-x: hidden;
}

.stars {
    background: 
        radial-gradient(2px 2px at 20% 30%, #00f2ff, transparent),
        radial-gradient(2px 2px at 60% 70%, #00f2ff, transparent),
        radial-gradient(1px 1px at 50% 50%, white, transparent),
        radial-gradient(1px 1px at 80% 10%, white, transparent),
        radial-gradient(2px 2px at 90% 60%, #00f2ff, transparent);
    animation: electricTwinkle 3s ease-in-out infinite;
}

@keyframes electricTwinkle {
    0%, 100% { opacity: 0.4; }
    50% { opacity: 0.7; }
}

/* Circuit Board Background Pattern */
.circuit-bg {
    position: fixed;
    inset: 0;
    background-image: 
        linear-gradient(90deg, rgba(0,242,255,0.03) 1px, transparent 1px),
        linear-gradient(rgba(0,242,255,0.03) 1px, transparent 1px);
    background-size: 50px 50px;
    pointer-events: none;
    z-index: 0;
    animation: circuitPulse 8s ease-in-out infinite;
}

@keyframes circuitPulse {
    0%, 100% { opacity: 0.3; }
    50% { opacity: 0.6; }
}

/* Lightning Bolts */
.lightning-container {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 1;
}

.lightning {
    position: absolute;
    width: 4px;
    height: 100px;
    background: linear-gradient(180deg, transparent, #00f2ff, transparent);
    box-shadow: 0 0 20px #00f2ff, 0 0 40px #00f2ff;
    animation: lightningStrike 4s ease-in-out infinite;
    opacity: 0;
}

.lightning:nth-child(1) { left: 20%; top: -100px; animation-delay: 0s; }
.lightning:nth-child(2) { left: 60%; top: -100px; animation-delay: 2s; }
.lightning:nth-child(3) { left: 85%; top: -100px; animation-delay: 3.5s; }

@keyframes lightningStrike {
    0% { transform: translateY(0) scaleY(0); opacity: 0; }
    5% { transform: translateY(200px) scaleY(2); opacity: 1; }
    10% { transform: translateY(400px) scaleY(1.5); opacity: 0.8; }
    15% { transform: translateY(600px) scaleY(0); opacity: 0; }
    100% { transform: translateY(600px) scaleY(0); opacity: 0; }
}

/* PowerGrid Container */
.powergrid-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
    position: relative;
    z-index: 10;
}

/* Energy Core Header */
.energy-core {
    text-align: center;
    margin: 30px 0 40px;
    position: relative;
}

.energy-title {
    font-size: 3rem;
    font-weight: 900;
    background: linear-gradient(135deg, #00f2ff, #00b8d4, #4facfe);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    text-shadow: 0 0 30px rgba(0,242,255,0.5);
    animation: energyPulse 2s ease-in-out infinite;
    display: inline-block;
}

@keyframes energyPulse {
    0%, 100% { transform: scale(1); filter: drop-shadow(0 0 20px rgba(0,242,255,0.6)); }
    50% { transform: scale(1.05); filter: drop-shadow(0 0 40px rgba(0,242,255,1)); }
}

.energy-subtitle {
    color: #6dd5ed;
    font-size: 1.1rem;
    margin-top: 10px;
    opacity: 0.9;
}

/* Power Level Battery */
.power-battery {
    width: 300px;
    height: 30px;
    border: 3px solid #00f2ff;
    border-radius: 20px;
    margin: 20px auto;
    position: relative;
    background: rgba(0,0,0,0.5);
    box-shadow: 
        0 0 20px rgba(0,242,255,0.4),
        inset 0 0 10px rgba(0,242,255,0.2);
}

.power-fill {
    height: 100%;
    background: linear-gradient(90deg, #00f2ff, #4facfe, #00f2ff);
    border-radius: 17px;
    width: 0%;
    transition: width 1s ease-out;
    box-shadow: 0 0 20px rgba(0,242,255,0.8);
    animation: energyFlow 2s linear infinite;
}

@keyframes energyFlow {
    0% { background-position: 0% 50%; }
    100% { background-position: 200% 50%; }
}

.power-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-weight: 700;
    font-size: 0.85rem;
    text-shadow: 0 0 10px rgba(0,0,0,0.8);
}

/* Study Mode Selector */
.mode-selector {
    display: flex;
    gap: 12px;
    justify-content: center;
    flex-wrap: wrap;
    margin: 30px 0;
}

.mode-btn {
    padding: 12px 24px;
    border-radius: 25px;
    border: 2px solid #00f2ff;
    background: linear-gradient(135deg, rgba(0,242,255,0.1), rgba(79,172,254,0.05));
    color: #00f2ff;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    box-shadow: 0 4px 15px rgba(0,242,255,0.2);
}

.mode-btn:hover, .mode-btn.active {
    background: linear-gradient(135deg, #00f2ff, #4facfe);
    color: white;
    transform: translateY(-3px) scale(1.05);
    box-shadow: 
        0 8px 25px rgba(0,242,255,0.5),
        0 0 30px rgba(0,242,255,0.4);
}

/* Main Study Guide */
.study-guide-wrapper {
    display: grid;
    grid-template-columns: 250px 1fr;
    gap: 30px;
    margin-top: 30px;
}

/* Table of Contents */
.toc-panel {
    background: linear-gradient(135deg, rgba(0,242,255,0.08), rgba(79,172,254,0.05));
    border: 2px solid rgba(0,242,255,0.3);
    border-radius: 20px;
    padding: 20px;
    height: fit-content;
    position: sticky;
    top: 20px;
    box-shadow: 0 8px 32px rgba(0,242,255,0.2);
    backdrop-filter: blur(10px);
}

.toc-title {
    color: #00f2ff;
    font-weight: 700;
    margin-bottom: 15px;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    gap: 8px;
}

.toc-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.toc-item {
    padding: 8px 12px;
    margin: 4px 0;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    color: #6dd5ed;
    font-size: 0.9rem;
}

.toc-item:hover {
    background: rgba(0,242,255,0.15);
    color: #00f2ff;
    transform: translateX(5px);
}

.toc-item.active {
    background: rgba(0,242,255,0.25);
    color: white;
    border-left: 3px solid #00f2ff;
}

/* Learning Tips Banner */
.learning-tips-banner {
    background: linear-gradient(135deg, rgba(132,255,0,0.15), rgba(0,242,255,0.1));
    border: 2px solid rgba(132,255,0,0.3);
    border-radius: 16px;
    padding: 20px;
    margin: 20px 0 30px;
    box-shadow: 0 8px 24px rgba(132,255,0,0.2);
    backdrop-filter: blur(10px);
}

.tips-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
    font-size: 1.1rem;
}

.tips-content {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.tip-item {
    color: #c4d1ff;
    font-size: 0.95rem;
    padding: 8px 12px;
    background: rgba(255,255,255,0.05);
    border-radius: 8px;
    border-left: 3px solid #84ff00;
}

.tips-tools {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 12px;
    margin-top: 10px;
    padding-top: 15px;
    border-top: 1px solid rgba(132,255,0,0.2);
}

.tool-link {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    background: rgba(0,242,255,0.2);
    border: 1px solid rgba(0,242,255,0.3);
    border-radius: 20px;
    color: #00f2ff;
    text-decoration: none;
    font-size: 0.9rem;
    font-weight: 600;
    transition: all 0.3s ease;
}

.tool-link:hover {
    background: rgba(0,242,255,0.3);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,242,255,0.4);
}

.learning-tips-cta {
    background: linear-gradient(135deg, rgba(102,126,234,0.15), rgba(118,75,162,0.1));
    border-color: rgba(102,126,234,0.3);
}

.learning-tips-cta .tips-content {
    flex-direction: row;
    align-items: center;
    justify-content: center;
    gap: 15px;
    color: #c4d1ff;
    font-size: 1.05rem;
}

.cta-btn {
    padding: 10px 24px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    text-decoration: none;
    border-radius: 20px;
    font-weight: 700;
    transition: all 0.3s ease;
}

.cta-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102,126,234,0.5);
}

/* Study Guide Content */
.study-content {
    background: linear-gradient(135deg, rgba(0,242,255,0.05), rgba(79,172,254,0.03));
    border: 2px solid rgba(0,242,255,0.25);
    border-radius: 20px;
    padding: 40px;
    box-shadow: 
        0 8px 32px rgba(0,0,0,0.3),
        0 0 60px rgba(0,242,255,0.15);
    backdrop-filter: blur(10px);
    line-height: 1.9;
}

.study-content h2 {
    color: #00f2ff;
    font-size: 1.8rem;
    font-weight: 700;
    margin: 35px 0 20px;
    padding-bottom: 12px;
    border-bottom: 2px solid rgba(0,242,255,0.3);
    display: flex;
    align-items: center;
    gap: 10px;
}

.study-content h2:first-child {
    margin-top: 0;
}

.study-content p {
    margin-bottom: 15px;
    line-height: 1.9;
    color: #c4d1ff;
    font-size: 1.05rem;
}

.study-content strong {
    color: #00f2ff;
    font-weight: 700;
}

.study-content em {
    color: #6dd5ed;
    font-style: italic;
}

.study-section {
    margin-bottom: 40px;
    padding: 25px;
    background: rgba(0,0,0,0.2);
    border-radius: 15px;
    border-left: 4px solid #00f2ff;
    transition: all 0.3s ease;
}

.study-section:hover {
    background: rgba(0,242,255,0.08);
    box-shadow: 0 0 30px rgba(0,242,255,0.2);
}

.section-title {
    color: #00f2ff;
    font-size: 1.8rem;
    font-weight: 700;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.section-content {
    color: #c4d1ff;
    line-height: 1.8;
    font-size: 1.05rem;
}

/* Progress Tracker */
.progress-tracker {
    position: fixed;
    bottom: 30px;
    right: 30px;
    background: linear-gradient(135deg, rgba(0,242,255,0.15), rgba(79,172,254,0.1));
    border: 2px solid #00f2ff;
    border-radius: 20px;
    padding: 15px 20px;
    box-shadow: 0 8px 32px rgba(0,242,255,0.4);
    backdrop-filter: blur(10px);
    z-index: 100;
}

.progress-text {
    color: #00f2ff;
    font-weight: 700;
    font-size: 0.9rem;
    margin-bottom: 8px;
}

.progress-bar {
    width: 200px;
    height: 8px;
    background: rgba(0,0,0,0.5);
    border-radius: 10px;
    overflow: hidden;
}

.progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #00f2ff, #4facfe);
    width: 0%;
    transition: width 0.3s ease;
    box-shadow: 0 0 10px rgba(0,242,255,0.8);
}

/* Highlight System */
.highlightable {
    cursor: text;
    position: relative;
}

.highlight {
    background: rgba(255,235,59,0.3);
    border-bottom: 2px solid #ffd54f;
    padding: 2px 0;
    cursor: pointer;
}

/* Flashcard Panel */
.flashcard-panel {
    margin-top: 30px;
    padding: 25px;
    background: linear-gradient(135deg, rgba(132,255,0,0.08), rgba(0,242,255,0.05));
    border: 2px solid rgba(132,255,0,0.3);
    border-radius: 20px;
    box-shadow: 0 8px 32px rgba(132,255,0,0.2);
}

.flashcard {
    background: rgba(0,0,0,0.4);
    border: 2px solid rgba(132,255,0,0.4);
    border-radius: 15px;
    padding: 20px;
    margin: 15px 0;
    cursor: pointer;
    transition: all 0.3s ease;
}

.flashcard:hover {
    transform: rotateY(5deg) scale(1.02);
    box-shadow: 0 8px 25px rgba(132,255,0,0.4);
}

.flashcard-number {
    position: absolute;
    top: 10px;
    right: 15px;
    background: rgba(132,255,0,0.3);
    color: #84ff00;
    padding: 5px 12px;
    border-radius: 20px;
    font-weight: 700;
    font-size: 0.9rem;
}

.flashcard-term {
    color: #84ff00;
    font-weight: 700;
    font-size: 1.2rem;
    margin-bottom: 10px;
}

.flashcard-def {
    color: #c4d1ff;
    line-height: 1.6;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid rgba(132,255,0,0.2);
}

.flashcard.flipped {
    background: linear-gradient(135deg, rgba(132,255,0,0.15), rgba(0,242,255,0.1));
}

/* Quiz Mode */
.quiz-container {
    margin-top: 30px;
    padding: 25px;
    background: linear-gradient(135deg, rgba(255,107,157,0.08), rgba(192,132,252,0.05));
    border: 2px solid rgba(255,107,157,0.3);
    border-radius: 20px;
    box-shadow: 0 8px 32px rgba(255,107,157,0.2);
}

.quiz-question {
    background: rgba(0,0,0,0.4);
    padding: 20px;
    border-radius: 15px;
    margin-bottom: 25px;
    border-left: 4px solid #ff6fd8;
    position: relative;
}

.quiz-question-number {
    color: #ff6fd8;
    font-weight: 700;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 10px;
}

.quiz-question-text {
    color: #fff;
    font-weight: 600;
    font-size: 1.2rem;
    margin-bottom: 20px;
    line-height: 1.5;
}

.quiz-q-text {
    color: #ff6fd8;
    font-weight: 700;
    font-size: 1.1rem;
    margin-bottom: 15px;
}

.quiz-options {
    display: grid;
    gap: 10px;
}

.quiz-option {
    padding: 15px 20px;
    background: rgba(0,242,255,0.1);
    border: 2px solid rgba(0,242,255,0.3);
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    color: #c4d1ff;
}

.quiz-option:hover {
    background: rgba(0,242,255,0.2);
    border-color: #00f2ff;
    transform: translateX(5px);
}

.quiz-option.selected {
    background: linear-gradient(135deg, rgba(255,107,157,0.3), rgba(192,132,252,0.2));
    border-color: #ff6fd8;
    color: #fff;
}

.quiz-option.correct {
    background: rgba(132,255,0,0.2);
    border-color: #84ff00;
}

.quiz-explanation {
    margin-top: 20px;
    padding: 15px;
    background: rgba(0,242,255,0.05);
    border-left: 3px solid #00f2ff;
    border-radius: 8px;
    color: #c4d1ff;
    line-height: 1.6;
}

.quiz-option.incorrect {
    background: rgba(255,63,52,0.2);
    border-color: #ff3f34;
}

/* Action Buttons */
.action-bar {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin: 25px 0;
    justify-content: center;
}

.power-btn {
    padding: 14px 28px;
    border-radius: 25px;
    border: none;
    background: linear-gradient(135deg, #00f2ff, #4facfe);
    color: white;
    font-weight: 700;
    cursor: pointer;
    box-shadow: 0 6px 20px rgba(0,242,255,0.4);
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    font-size: 1rem;
    position: relative;
    overflow: hidden;
}

.power-btn::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255,255,255,0.3);
    transform: translate(-50%, -50%);
    transition: width 0.5s, height 0.5s;
}

.power-btn:hover::before {
    width: 400px;
    height: 400px;
}

.power-btn:hover {
    transform: translateY(-4px) scale(1.05);
    box-shadow: 0 12px 35px rgba(0,242,255,0.6);
}

/* Support Panels */
.support-panel {
    margin: 20px 0;
    background: linear-gradient(135deg, rgba(0,242,255,0.08), rgba(79,172,254,0.05));
    border: 2px solid rgba(0,242,255,0.3);
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 8px 32px rgba(0,242,255,0.2);
    backdrop-filter: blur(10px);
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.panel-header {
    background: linear-gradient(135deg, rgba(0,242,255,0.15), rgba(79,172,254,0.1));
    padding: 18px 25px;
    color: #00f2ff;
    font-weight: 700;
    font-size: 1.3rem;
    border-bottom: 2px solid rgba(0,242,255,0.3);
}

.panel-content {
    padding: 25px;
    color: #c4d1ff;
    line-height: 1.8;
}

.panel-content h4 {
    margin-top: 20px;
    margin-bottom: 12px;
}

.panel-content ul {
    margin: 10px 0;
    padding-left: 25px;
}

.panel-content li {
    margin-bottom: 8px;
    color: #c4d1ff;
}

/* Responsive */
@media (max-width: 1024px) {
    .study-guide-wrapper {
        grid-template-columns: 1fr;
    }

    .toc-panel {
        position: relative;
        top: 0;
    }
}

@media (max-width: 768px) {
    .energy-title {
        font-size: 2rem;
    }
    
    .power-battery {
        width: 200px;
    }
    
    .study-content {
        padding: 20px;
    }
    
    .progress-tracker {
        bottom: 10px;
        right: 10px;
        padding: 10px;
    }
}
</style>

<div class="circuit-bg"></div>
<div class="lightning-container">
    <div class="lightning"></div>
    <div class="lightning"></div>
    <div class="lightning"></div>
</div>

<div class="powergrid-container">
    <!-- Energy Core Header -->
    <div class="energy-core">
        <div class="energy-title">‚ö° POWERGRID ‚ö°</div>
        <div class="energy-subtitle">Master Study Guide Generator</div>
        
        <!-- Power Battery -->
        <div class="power-battery">
            <div class="power-fill" id="powerFill"></div>
            <div class="power-text" id="powerText">Energy Level: 0%</div>
        </div>
    </div>

    <!-- Study Mode Selector - Regenerate Guide -->
    <div class="mode-selector">
        <form id="modeForm" action="/powergrid_regenerate" method="POST" style="display: contents;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="study_mode" id="selectedMode" value="standard">
            <input type="hidden" name="learning_style" value="balanced">

            <button type="button" class="mode-btn active" data-mode="standard" onclick="regenerateWithMode('standard')">üìö Standard</button>
            <button type="button" class="mode-btn" data-mode="quick" onclick="regenerateWithMode('quick')">‚ö° Quick Summary</button>
            <button type="button" class="mode-btn" data-mode="deep" onclick="regenerateWithMode('deep')">üî¨ Deep Dive</button>
            <button type="button" class="mode-btn" data-mode="socratic" onclick="regenerateWithMode('socratic')">üí≠ Socratic Mode</button>
            <button type="button" class="mode-btn" data-mode="flashcards">üé¥ Flashcards</button>
            <button type="button" class="mode-btn" data-mode="quiz">üéØ Quiz Me</button>
        </form>
    </div>

    <!-- Loading Overlay -->
    <div id="regenerateOverlay" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 10000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
            <div style="font-size: 4rem; animation: spin 1s linear infinite;">‚ö°</div>
            <div style="color: #00f2ff; font-size: 1.5rem; font-weight: 700; margin-top: 20px;">Regenerating Study Guide...</div>
            <div style="color: #6dd5ed; font-size: 1rem; margin-top: 10px;">This may take a few moments</div>
        </div>
    </div>

    <!-- Learning Support Buttons -->
    <div class="mode-selector" style="margin-bottom: 15px;">
        <button type="button" class="mode-btn" onclick="togglePanel('studyTechniques')">üìö Study Techniques</button>
        <button type="button" class="mode-btn" onclick="togglePanel('realWorld')">üåç Real-World Connections</button>
        <button type="button" class="mode-btn" onclick="togglePanel('learningSupport')">üß† Learning Support</button>
    </div>

    <!-- Collapsible Panels -->
    <div id="studyTechniques" class="support-panel" style="display: none;">
        <div class="panel-header">üìö Study Techniques</div>
        <div class="panel-content" id="studyTechniquesContent">
            <p style="color: #c4d1ff;">Loading study techniques...</p>
        </div>
    </div>

    <div id="realWorld" class="support-panel" style="display: none;">
        <div class="panel-header">üåç Real-World Connections</div>
        <div class="panel-content" id="realWorldContent">
            <p style="color: #c4d1ff;">Loading real-world connections...</p>
        </div>
    </div>

    <div id="learningSupport" class="support-panel" style="display: none;">
        <div class="panel-header">üß† Learning Support Strategies</div>
        <div class="panel-content" id="learningSupportContent">
            <div style="margin-bottom: 20px;">
                <h4 style="color: #00f2ff; margin-bottom: 10px;">üí° ADHD-Friendly Strategies</h4>
                <ul style="color: #c4d1ff; line-height: 1.8;">
                    <li>Break content into micro-chunks (5-10 min sessions)</li>
                    <li>Take movement breaks every 15-20 minutes</li>
                    <li>Use fidget tools while studying (stress ball, fidget spinner)</li>
                    <li>Minimize distractions (turn off notifications, quiet space)</li>
                    <li>Use timers for focused study bursts (Pomodoro technique)</li>
                </ul>
            </div>
            <div style="margin-bottom: 20px;">
                <h4 style="color: #00f2ff; margin-bottom: 10px;">üìñ Dyslexia-Friendly Strategies</h4>
                <ul style="color: #c4d1ff; line-height: 1.8;">
                    <li>Use text-to-speech to hear content while reading</li>
                    <li>Try colored overlays or change background colors</li>
                    <li>Use visual organizers (mind maps, charts)</li>
                    <li>Chunk text into smaller sections</li>
                    <li>Highlight key words in different colors</li>
                </ul>
            </div>
            <div style="margin-bottom: 20px;">
                <h4 style="color: #00f2ff; margin-bottom: 10px;">‚è±Ô∏è Processing Support</h4>
                <ul style="color: #c4d1ff; line-height: 1.8;">
                    <li>Allow extra time to process information</li>
                    <li>Review step-by-step breakdowns multiple times</li>
                    <li>Use visual aids alongside text descriptions</li>
                    <li>Practice with examples before trying new problems</li>
                    <li>Ask for clarification when needed</li>
                </ul>
            </div>
            <div style="margin-bottom: 20px;">
                <h4 style="color: #00f2ff; margin-bottom: 10px;">üß© Memory Support</h4>
                <ul style="color: #c4d1ff; line-height: 1.8;">
                    <li>Use spaced repetition (review material multiple times)</li>
                    <li>Create associations and connections to things you know</li>
                    <li>Practice hands-on with real objects when possible</li>
                    <li>Make up songs, rhymes, or stories to remember facts</li>
                    <li>Use visual mnemonics and memory palaces</li>
                </ul>
            </div>
            <div style="margin-bottom: 20px;">
                <h4 style="color: #00f2ff; margin-bottom: 10px;">‚úÖ Executive Function Support</h4>
                <ul style="color: #c4d1ff; line-height: 1.8;">
                    <li>Use checklists to track what you need to do</li>
                    <li>Set timers for different study tasks</li>
                    <li>Create an organization system (folders, binders, digital)</li>
                    <li>Break big tasks into smaller, manageable steps</li>
                    <li>Prioritize: do the hardest tasks when you have most energy</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Action Bar -->
    <div class="action-bar">
        {% if pdf_url %}
        <a href="{{ pdf_url }}" download class="power-btn">üìò Download PDF</a>
        {% endif %}
        <button class="power-btn" onclick="printStudyGuide()">üñ®Ô∏è Print Guide</button>
        <button class="power-btn" onclick="shareWithTeacher()">üë©‚Äçüè´ Share with Teacher</button>
        <button class="power-btn" onclick="saveToLibrary()">üíæ Save to Library</button>
        <button class="power-btn" onclick="toggleHighlightMode()">üñçÔ∏è Highlight Mode</button>
    </div>

    <!-- Personalized Learning Tips -->
    {% if learning_tips and learning_tips.has_profile %}
    <div class="learning-tips-banner">
        <div class="tips-header">
            <span style="font-size: 1.3rem;">üí°</span>
            <span style="font-weight: 700; color: #84ff00;">Recommended for You ({{ learning_tips.primary_style }})</span>
        </div>
        <div class="tips-content">
            {% if learning_tips.tips %}
                {% for tip in learning_tips.tips %}
                <div class="tip-item">‚úì {{ tip }}</div>
                {% endfor %}
            {% endif %}
            {% if learning_tips.tools %}
                <div class="tips-tools">
                    <span style="color: #00f2ff; font-weight: 600;">Helpful Tools:</span>
                    {% for tool in learning_tips.tools %}
                    <a href="{{ tool.link }}" class="tool-link">{{ tool.icon }} {{ tool.name }}</a>
                    {% endfor %}
                </div>
            {% endif %}

            <!-- Alternative Learning Approaches -->
            {% if learning_tips.alternative_approaches %}
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(132, 255, 0, 0.2);">
                    <div style="color: #c4d1ff; font-size: 0.9rem; margin-bottom: 10px; opacity: 0.9;">
                        <strong>Or try these approaches:</strong> <span style="font-style: italic; font-size: 0.85rem;">{{ learning_tips.flexibility_message }}</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                        {% for approach in learning_tips.alternative_approaches %}
                        <div style="background: rgba(0, 242, 255, 0.1); border: 1px solid rgba(0, 242, 255, 0.3); border-radius: 8px; padding: 10px;">
                            <div style="color: #00f2ff; font-weight: 600; font-size: 0.85rem; margin-bottom: 5px;">
                                {{ approach.icon }} {{ approach.style }}
                            </div>
                            <div style="color: #c4d1ff; font-size: 0.8rem;">{{ approach.tip }}</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
    {% elif learning_tips and not learning_tips.has_profile %}
    <div class="learning-tips-banner learning-tips-cta">
        <div class="tips-content">
            <span style="font-size: 1.5rem; margin-right: 10px;">üß†</span>
            <span>{{ learning_tips.cta }}</span>
            <a href="{{ learning_tips.cta_link }}" class="cta-btn">Get Started ‚Üí</a>
        </div>
    </div>
    {% endif %}

    <!-- Study Guide with TOC -->
    <div class="study-guide-wrapper">
        <!-- Table of Contents -->
        <div class="toc-panel">
            <div class="toc-title">üìë Contents</div>
            <ul class="toc-list" id="tocList">
                <!-- Generated by JavaScript -->
            </ul>
        </div>

        <!-- Main Study Content -->
        <div class="study-content" id="studyContent">
            <div class="highlightable" id="formattedContent">
                <!-- Content formatted by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Flashcard Panel (hidden by default) -->
    <div class="flashcard-panel" id="flashcardPanel" style="display:none;">
        <h3 style="color: #84ff00; margin-bottom: 20px;">üé¥ Generated Flashcards</h3>
        <div id="flashcardContainer"></div>
    </div>

    <!-- Quiz Panel (hidden by default) -->
    <div class="quiz-container" id="quizPanel" style="display:none;">
        <h3 style="color: #ff6fd8; margin-bottom: 20px;">üéØ Practice Quiz</h3>
        <div id="quizContainer"></div>
    </div>

    <!-- Progress Tracker -->
    <div class="progress-tracker">
        <div class="progress-text" id="progressText">Progress: 0%</div>
        <div class="progress-bar">
            <div class="progress-bar-fill" id="progressFill"></div>
        </div>
        <div style="color: #6dd5ed; font-size: 0.85rem; margin-top: 5px;" id="timeEstimate">Est. time: --</div>
    </div>
</div>

<script>
// Study Mode Management
let currentMode = 'standard';
let highlightMode = false;
const studyText = {{ answer|tojson }};

// Regenerate study guide with selected mode
function regenerateWithMode(mode) {
    // Show loading overlay
    document.getElementById('regenerateOverlay').style.display = 'block';

    // Update active button
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    document.querySelector(`[data-mode="${mode}"]`).classList.add('active');

    // Set mode and submit form
    document.getElementById('selectedMode').value = mode;
    document.getElementById('modeForm').submit();
}

// Toggle Support Panels
function togglePanel(panelId) {
    const panel = document.getElementById(panelId);
    if (panel.style.display === 'none') {
        panel.style.display = 'block';
        // Extract content from study guide on first open
        if (panelId === 'studyTechniques' && panel.dataset.loaded !== 'true') {
            extractStudyTechniques();
            panel.dataset.loaded = 'true';
        } else if (panelId === 'realWorld' && panel.dataset.loaded !== 'true') {
            extractRealWorld();
            panel.dataset.loaded = 'true';
        }
    } else {
        panel.style.display = 'none';
    }
}

// Extract Study Techniques section from AI-generated content
function extractStudyTechniques() {
    const content = extractSection('STUDY TECHNIQUES');
    const container = document.getElementById('studyTechniquesContent');
    if (content) {
        container.innerHTML = formatExtractedContent(content);
    } else {
        container.innerHTML = `
            <ul style="color: #c4d1ff; line-height: 1.8;">
                <li><strong style="color: #00f2ff;">Active Recall:</strong> Test yourself regularly instead of just re-reading</li>
                <li><strong style="color: #00f2ff;">Spaced Repetition:</strong> Review material at increasing intervals</li>
                <li><strong style="color: #00f2ff;">Teach Someone:</strong> Explain concepts to others to deepen understanding</li>
                <li><strong style="color: #00f2ff;">Practice Problems:</strong> Do lots of examples to build mastery</li>
                <li><strong style="color: #00f2ff;">Make Connections:</strong> Link new info to things you already know</li>
            </ul>
        `;
    }
}

// Extract Real-World Connections section from AI-generated content
function extractRealWorld() {
    const content = extractSection('REAL-WORLD CONNECTIONS') || extractSection('REAL WORLD');
    const container = document.getElementById('realWorldContent');
    if (content) {
        container.innerHTML = formatExtractedContent(content);
    } else {
        container.innerHTML = `
            <p style="color: #c4d1ff;">This topic connects to many real-world applications. Look for examples in your daily life where these concepts appear!</p>
        `;
    }
}

// Extract a section from the study guide by title
function extractSection(sectionTitle) {
    const lines = studyText.split('\n');
    let inSection = false;
    let sectionContent = [];

    for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();

        // Check if this line is the section header we're looking for
        if (line.toUpperCase().includes(sectionTitle)) {
            inSection = true;
            continue;
        }

        // If we're in the section, collect content until next major header
        if (inSection) {
            // Stop if we hit another major section
            if (line.match(/^[‚ïê=\-]+\s*[‚ú¶‚óÜ‚ü°‚åÅ‚úß‚ö†]/) ||
                (line === line.toUpperCase() && line.length > 10 && line.length < 100)) {
                break;
            }
            if (line) {
                sectionContent.push(line);
            }
        }
    }

    return sectionContent.length > 0 ? sectionContent.join('\n') : null;
}

// Format extracted content with proper HTML
function formatExtractedContent(content) {
    let html = '';
    const lines = content.split('\n');
    let inList = false;

    lines.forEach(line => {
        line = line.trim();
        if (!line) return;

        if (line.match(/^[‚Ä¢\-\*]\s+/)) {
            if (!inList) {
                html += '<ul style="color: #c4d1ff; line-height: 1.8; margin: 10px 0; padding-left: 25px;">';
                inList = true;
            }
            html += `<li>${processMarkdown(line.substring(1).trim())}</li>`;
        } else {
            if (inList) {
                html += '</ul>';
                inList = false;
            }
            html += `<p style="margin-bottom: 12px; color: #c4d1ff;">${processMarkdown(line)}</p>`;
        }
    });

    if (inList) {
        html += '</ul>';
    }

    return html || '<p style="color: #c4d1ff;">Content will appear here when generated.</p>';
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    formatStudyGuide();
    generateTOC();
    trackProgress();
    animatePowerBattery();
    calculateReadingTime();

    // Mode selector for non-regenerating modes (flashcards, quiz)
    document.querySelectorAll('.mode-btn').forEach(btn => {
        if(btn.dataset.mode === 'flashcards' || btn.dataset.mode === 'quiz') {
            btn.addEventListener('click', () => {
                currentMode = btn.dataset.mode;
                handleModeChange(currentMode);
            });
        }
    });
});

// Process markdown formatting (bold, italic, etc.)
function processMarkdown(text) {
    // Convert **bold** to <strong>
    text = text.replace(/\*\*(.+?)\*\*/g, '<strong style="color: #00f2ff;">$1</strong>');
    // Convert *italic* to <em>
    text = text.replace(/\*(.+?)\*/g, '<em style="color: #6dd5ed;">$1</em>');
    return text;
}

// Format Study Guide with proper HTML structure
function formatStudyGuide() {
    const container = document.getElementById('formattedContent');
    const lines = studyText.split('\n');
    let html = '';
    let inBulletList = false;

    lines.forEach(line => {
        line = line.trim();
        if (!line) {
            if (inBulletList) {
                html += '</ul>';
                inBulletList = false;
            }
            html += '<br>';
            return;
        }
        
        // PowerGrid section headers with decorative lines (e.g., ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ‚ú¶ TITLE ‚ú¶ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê)
        if (line.match(/^[‚ïê=\-]+\s*[‚ú¶‚óÜ‚ü°‚åÅ‚úß‚ö†]\s*.+?\s*[‚ú¶‚óÜ‚ü°‚åÅ‚úß‚ö†]\s*[‚ïê=\-]+$/)) {
            if (inBulletList) {
                html += '</ul>';
                inBulletList = false;
            }
            // Extract just the title part
            const titleMatch = line.match(/[‚ú¶‚óÜ‚ü°‚åÅ‚úß‚ö†]\s*(.+?)\s*[‚ú¶‚óÜ‚ü°‚åÅ‚úß‚ö†]/);
            const title = titleMatch ? titleMatch[1].trim() : line;
            html += `<h2 class="section-title" style="margin-top: 40px; margin-bottom: 20px;">${processMarkdown(title)}</h2>`;
        }
        // Regular ALL CAPS headers or numbered sections
        else if ((line === line.toUpperCase() && line.length > 3 && line.length < 100 && !line.includes('=')) ||
                 line.match(/^(SECTION\s+\d+|\d+\.)\s*‚Äî?\s*[A-Z]/)) {
            if (inBulletList) {
                html += '</ul>';
                inBulletList = false;
            }
            html += `<h2 class="section-title" style="margin-top: 35px; margin-bottom: 18px;">${processMarkdown(line)}</h2>`;
        }
        // Bullet points
        else if (line.match(/^[‚Ä¢\-\*]\s+/)) {
            if (!inBulletList) {
                html += '<ul style="margin: 15px 0; padding-left: 25px;">';
                inBulletList = true;
            }
            const bulletText = processMarkdown(line.substring(1).trim());
            html += `<li style="margin-bottom: 10px; color: #c4d1ff; line-height: 1.7;"><span style="color: #00f2ff;">‚ö°</span> ${bulletText}</li>`;
        }
        // Sub-bullets (indented)
        else if (line.match(/^\s{2,}[‚Ä¢\-\*]/)) {
            const subBulletText = processMarkdown(line.trim().substring(1).trim());
            html += `<li style="margin-left: 30px; margin-bottom: 8px; color: #a8b9ff; font-size: 0.95rem; list-style: none;">‚Üí ${subBulletText}</li>`;
        }
        // Questions (for Socratic mode)
        else if (line.endsWith('?') && line.length > 10) {
            if (inBulletList) {
                html += '</ul>';
                inBulletList = false;
            }
            html += `<div style="margin: 18px 0; padding: 14px; background: rgba(0,242,255,0.1); border-left: 4px solid #00f2ff; border-radius: 10px; color: #00f2ff; font-weight: 600; font-size: 1.05rem;">${processMarkdown(line)}</div>`;
        }
        // Decorative separators (skip them)
        else if (line.match(/^[‚ïê=\-]+$/)) {
            // Skip pure separator lines
            return;
        }
        // Code or examples (lines with backticks)
        else if (line.includes('```')) {
            if (inBulletList) {
                html += '</ul>';
                inBulletList = false;
            }
            html += `<div style="margin: 12px 0; padding: 12px; background: rgba(0,0,0,0.5); border: 1px solid rgba(0,242,255,0.3); border-radius: 8px; font-family: 'Courier New', monospace; color: #84ff00; font-size: 0.9rem; overflow-x: auto;">${line.replace(/```/g, '')}</div>`;
        }
        // Regular paragraphs
        else {
            if (inBulletList) {
                html += '</ul>';
                inBulletList = false;
            }
            html += `<p style="margin-bottom: 16px; line-height: 1.9; color: #c4d1ff; font-size: 1.05rem;">${processMarkdown(line)}</p>`;
        }
    });
    
    if (inBulletList) {
        html += '</ul>';
    }
    
    container.innerHTML = html;
}

// Generate Table of Contents
function generateTOC() {
    const content = document.getElementById('studyContent');
    const tocList = document.getElementById('tocList');
    const sections = content.querySelectorAll('h1, h2, h3');
    
    sections.forEach((section, index) => {
        const id = `section-${index}`;
        section.id = id;
        section.classList.add('section-title');
        
        const li = document.createElement('li');
        li.className = 'toc-item';
        li.textContent = section.textContent;
        li.onclick = () => {
            document.getElementById(id).scrollIntoView({ behavior: 'smooth' });
            document.querySelectorAll('.toc-item').forEach(item => item.classList.remove('active'));
            li.classList.add('active');
        };
        tocList.appendChild(li);
    });
}

// Track Reading Progress
function trackProgress() {
    const content = document.getElementById('studyContent');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    
    window.addEventListener('scroll', () => {
        const scrollTop = window.scrollY;
        const docHeight = document.documentElement.scrollHeight - window.innerHeight;
        const scrollPercent = (scrollTop / docHeight) * 100;
        
        progressFill.style.width = scrollPercent + '%';
        progressText.textContent = `Progress: ${Math.round(scrollPercent)}%`;
        
        // Update TOC active state
        const sections = Array.from(document.querySelectorAll('.section-title'));
        const current = sections.reverse().find(section => section.offsetTop <= scrollTop + 100);
        if (current) {
            document.querySelectorAll('.toc-item').forEach(item => item.classList.remove('active'));
            const index = Array.from(document.querySelectorAll('.section-title')).indexOf(current);
            document.querySelectorAll('.toc-item')[index]?.classList.add('active');
        }
    });
}

// Animate Power Battery
function animatePowerBattery() {
    let power = 0;
    const fill = document.getElementById('powerFill');
    const text = document.getElementById('powerText');
    
    const interval = setInterval(() => {
        power += 2;
        fill.style.width = power + '%';
        text.textContent = `Energy Level: ${power}%`;
        
        if (power >= 100) {
            clearInterval(interval);
            text.textContent = 'Fully Charged! ‚ö°';
        }
    }, 30);
}

// Calculate Reading Time
function calculateReadingTime() {
    const words = studyText.split(/\s+/).length;
    const wpm = 200; // average reading speed
    const minutes = Math.ceil(words / wpm);
    document.getElementById('timeEstimate').textContent = `Est. time: ${minutes} min`;
}

// Handle Mode Changes
function handleModeChange(mode) {
    const flashcardPanel = document.getElementById('flashcardPanel');
    const quizPanel = document.getElementById('quizPanel');
    
    flashcardPanel.style.display = 'none';
    quizPanel.style.display = 'none';
    
    if (mode === 'flashcards') {
        flashcardPanel.style.display = 'block';
        generateFlashcards();
    } else if (mode === 'quiz') {
        quizPanel.style.display = 'block';
        generateQuiz();
    } else if (mode === 'quick') {
        // TODO: Show condensed summary
        alert('Quick summary mode - showing condensed version');
    } else if (mode === 'deep') {
        // TODO: Show expanded version
        alert('Deep dive mode - showing detailed version');
    } else if (mode === 'socratic') {
        // TODO: Start Socratic questioning
        alert('Socratic mode - AI will ask you questions');
    }
}

// Generate Flashcards with AI
async function generateFlashcards() {
    const container = document.getElementById('flashcardContainer');
    container.innerHTML = '<div style="text-align: center; padding: 40px;"><div style="font-size: 3rem; animation: spin 1s linear infinite;">üé¥</div><p style="color: #00f2ff; margin-top: 20px;">AI is generating flashcards from your study guide...</p></div>';

    try {
        const response = await fetch('/powergrid/generate_flashcards', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                study_guide_text: studyText,
                subject: '{{ subject }}',
                topic: '{{ question }}',
                grade_level: '{{ grade }}',
                count: 10
            })
        });

        const data = await response.json();

        if (data.success && data.flashcards) {
            container.innerHTML = '';

            data.flashcards.forEach((card, index) => {
                const div = document.createElement('div');
                div.className = 'flashcard';
                div.style.animationDelay = `${index * 0.1}s`;
                div.innerHTML = `
                    <div class="flashcard-number">${index + 1}</div>
                    <div class="flashcard-term">${card.term}</div>
                    <div class="flashcard-def" style="display:none;">${card.definition}</div>
                    <div class="flashcard-hint" style="text-align: center; color: #6dd5ed; font-size: 0.85rem; margin-top: 10px;">
                        Click to reveal answer
                    </div>
                `;
                div.onclick = () => {
                    const defElement = div.querySelector('.flashcard-def');
                    const hintElement = div.querySelector('.flashcard-hint');
                    if (defElement.style.display === 'none') {
                        defElement.style.display = 'block';
                        hintElement.style.display = 'none';
                        div.classList.add('flipped');
                    } else {
                        defElement.style.display = 'none';
                        hintElement.style.display = 'block';
                        div.classList.remove('flipped');
                    }
                };
                container.appendChild(div);
            });

            // Add a summary
            const summary = document.createElement('div');
            summary.style.cssText = 'text-align: center; margin-top: 30px; padding: 20px; background: rgba(0,242,255,0.1); border-radius: 12px;';
            summary.innerHTML = `
                <p style="color: #00f2ff; font-size: 1.1rem; margin: 0;">
                    ‚ú® Generated ${data.flashcards.length} flashcards! Click each card to reveal the answer.
                </p>
            `;
            container.appendChild(summary);
        } else {
            throw new Error(data.error || 'Failed to generate flashcards');
        }
    } catch (error) {
        console.error('Flashcard generation error:', error);
        container.innerHTML = `
            <div style="text-align: center; padding: 40px;">
                <p style="color: #ff6fd8; font-size: 1.2rem;">‚ö†Ô∏è Oops! Couldn't generate flashcards.</p>
                <p style="color: #c4d1ff; margin-top: 10px;">Try again or create your own flashcards from the study guide.</p>
            </div>
        `;
    }
}

// Generate Quiz with AI
async function generateQuiz() {
    const container = document.getElementById('quizContainer');
    container.innerHTML = '<div style="text-align: center; padding: 40px;"><div style="font-size: 3rem; animation: spin 1s linear infinite;">üéØ</div><p style="color: #ff6fd8; margin-top: 20px;">AI is creating practice questions...</p></div>';

    try {
        const response = await fetch('/powergrid/generate_quiz', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                study_guide_text: studyText,
                subject: '{{ subject }}',
                topic: '{{ question }}',
                grade_level: '{{ grade }}',
                num_questions: 5
            })
        });

        const data = await response.json();

        if (data.success && data.questions) {
            container.innerHTML = '';

            let quizHTML = '<div class="quiz-questions">';

            data.questions.forEach((q, index) => {
                quizHTML += `
                    <div class="quiz-question" data-question-index="${index}">
                        <div class="quiz-question-number">Question ${index + 1}</div>
                        <div class="quiz-question-text">${q.question}</div>
                        <div class="quiz-options">
                `;

                q.options.forEach((option, optIndex) => {
                    const letter = option.charAt(0); // A, B, C, or D
                    quizHTML += `
                        <div class="quiz-option" onclick="selectQuizAnswer(${index}, '${letter}')">
                            ${option}
                        </div>
                    `;
                });

                quizHTML += `
                        </div>
                        <div class="quiz-explanation" style="display: none;">
                            <strong style="color: #00f2ff;">Correct Answer: ${q.correct_answer}</strong><br>
                            ${q.explanation}
                        </div>
                    </div>
                `;
            });

            quizHTML += '</div>';
            quizHTML += `
                <div style="text-align: center; margin-top: 30px;">
                    <button class="power-btn" onclick="checkQuizAnswers()">üìù Check My Answers</button>
                </div>
            `;

            container.innerHTML = quizHTML;

            // Store quiz data globally
            window.quizData = data.questions;
            window.userAnswers = {};
        } else {
            throw new Error(data.error || 'Failed to generate quiz');
        }
    } catch (error) {
        console.error('Quiz generation error:', error);
        container.innerHTML = `
            <div style="text-align: center; padding: 40px;">
                <p style="color: #ff6fd8; font-size: 1.2rem;">‚ö†Ô∏è Oops! Couldn't generate quiz.</p>
                <p style="color: #c4d1ff; margin-top: 10px;">Try again or review your study guide.</p>
            </div>
        `;
    }
}

// Select quiz answer
function selectQuizAnswer(questionIndex, answer) {
    window.userAnswers[questionIndex] = answer;

    // Update visual selection
    const questionDiv = document.querySelector(`[data-question-index="${questionIndex}"]`);
    const options = questionDiv.querySelectorAll('.quiz-option');

    options.forEach(option => {
        option.classList.remove('selected');
        if (option.textContent.trim().startsWith(answer + ')')) {
            option.classList.add('selected');
        }
    });
}

// Check quiz answers
function checkQuizAnswers() {
    if (!window.quizData) return;

    let correct = 0;
    let total = window.quizData.length;

    window.quizData.forEach((question, index) => {
        const questionDiv = document.querySelector(`[data-question-index="${index}"]`);
        const userAnswer = window.userAnswers[index];
        const correctAnswer = question.correct_answer;
        const options = questionDiv.querySelectorAll('.quiz-option');
        const explanation = questionDiv.querySelector('.quiz-explanation');

        // Show explanation
        explanation.style.display = 'block';

        // Highlight correct and incorrect
        options.forEach(option => {
            const letter = option.textContent.trim().charAt(0);
            if (letter === correctAnswer) {
                option.style.background = 'linear-gradient(135deg, rgba(0,255,0,0.2), rgba(0,255,0,0.1))';
                option.style.borderColor = '#00ff00';
            } else if (letter === userAnswer && userAnswer !== correctAnswer) {
                option.style.background = 'linear-gradient(135deg, rgba(255,0,0,0.2), rgba(255,0,0,0.1))';
                option.style.borderColor = '#ff0000';
            }
        });

        if (userAnswer === correctAnswer) {
            correct++;
        }
    });

    // Show score
    const percentage = Math.round((correct / total) * 100);
    let message = '';
    let emoji = '';

    if (percentage >= 90) {
        emoji = 'üåü';
        message = 'Outstanding! You really know this material!';
    } else if (percentage >= 70) {
        emoji = '‚ú®';
        message = 'Great job! You have a solid understanding!';
    } else if (percentage >= 50) {
        emoji = 'üí™';
        message = 'Good effort! Review the explanations and try again.';
    } else {
        emoji = 'üìö';
        message = 'Keep studying! Review the study guide and try again.';
    }

    const scoreDiv = document.createElement('div');
    scoreDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: linear-gradient(135deg, #667eea, #764ba2); padding: 40px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); z-index: 10000; text-align: center; min-width: 300px;';
    scoreDiv.innerHTML = `
        <div style="font-size: 4rem; margin-bottom: 20px;">${emoji}</div>
        <div style="font-size: 2rem; font-weight: 700; color: white; margin-bottom: 10px;">
            ${correct} / ${total} Correct
        </div>
        <div style="font-size: 1.5rem; color: #f5576c; margin-bottom: 20px;">
            ${percentage}%
        </div>
        <p style="color: white; font-size: 1.1rem; margin-bottom: 30px;">
            ${message}
        </p>
        <button class="power-btn" onclick="this.parentElement.remove()" style="background: white; color: #667eea;">
            Close
        </button>
    `;

    document.body.appendChild(scoreDiv);
}

// Highlight Mode
function toggleHighlightMode() {
    highlightMode = !highlightMode;
    alert(highlightMode ? 'Highlight mode ON - select text to highlight' : 'Highlight mode OFF');
    
    if (highlightMode) {
        document.getElementById('studyContent').addEventListener('mouseup', handleHighlight);
    } else {
        document.getElementById('studyContent').removeEventListener('mouseup', handleHighlight);
    }
}

function handleHighlight() {
    const selection = window.getSelection();
    if (selection.toString().length > 0) {
        const range = selection.getRangeAt(0);
        const span = document.createElement('span');
        span.className = 'highlight';
        range.surroundContents(span);
    }
}

// Action Functions
function printStudyGuide() {
    window.print();
}

function shareWithTeacher() {
    alert('Study guide will be shared with your teacher!');
    // TODO: Implement server-side sharing
}

function saveToLibrary() {
    alert('Study guide saved to your personal library!');
    // TODO: Implement library storage
}
</script>

{% endblock %}
